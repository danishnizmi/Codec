# EC2 IP-Based Deployment Guide (No Domain Required)

This guide is for deploying the marketplace POC using **just your EC2 public IP address** without a domain name. Perfect for early-stage development and testing.

## Prerequisites

- AWS EC2 t3.micro instance (Ubuntu 22.04)
- EC2 public IP address
- Security group allowing ports: 22 (SSH), 80 (HTTP)

⚠️ **Note**: This setup uses HTTP (not HTTPS). For production with SSL, see the main README.md.

## Quick Deployment (5 Minutes)

### Step 1: Launch EC2 Instance

```bash
# 1. Launch t3.micro with Ubuntu 22.04
# 2. Configure Security Group:
#    - SSH (22): Your IP
#    - HTTP (80): 0.0.0.0/0 (anywhere)
# 3. Use user_data.sh for automated setup
# 4. Note your EC2 Public IP: e.g., 54.123.45.67
```

### Step 2: SSH Into Instance

```bash
ssh -i your-key.pem ubuntu@YOUR_EC2_IP

# Wait for user_data.sh to complete (~5 minutes)
# Check status:
tail -f /var/log/user-data.log
```

### Step 3: Clone Repository

```bash
cd /opt
sudo git clone https://github.com/yourusername/your-repo.git marketplace
sudo chown -R ubuntu:ubuntu marketplace
cd marketplace
```

### Step 4: Run Automated Setup

```bash
./setup.sh
```

**Interactive Prompts**:

1. **AWS Credentials** (required for image uploads):
   ```
   Enter AWS Access Key ID: AKIAXXXXXXXXXXXXXXXX
   Enter AWS Secret Access Key: ********
   Enter S3 Bucket Name: my-marketplace-bucket
   ```

2. **EC2 Public IP** (IMPORTANT):
   ```
   Enter EC2 Public IP: 54.123.45.67
   ```

The script will automatically:
- ✅ Generate secure PostgreSQL password
- ✅ Generate API secret key
- ✅ Configure AWS S3
- ✅ Set up CORS for your EC2 IP
- ✅ Configure frontend API URL with your IP

### Step 5: Start Services

```bash
docker-compose up -d

# Wait for services to start (~30 seconds)
docker-compose ps

# Check logs
docker-compose logs -f
```

### Step 6: Verify Deployment

```bash
# Run health check
./health-check.sh

# Or manually test:
curl http://YOUR_EC2_IP/api/health
# Expected: {"status":"healthy","environment":"production"}

curl -I http://YOUR_EC2_IP
# Expected: HTTP/1.1 200 OK
```

### Step 7: Access Your Marketplace

Open in browser:
```
http://YOUR_EC2_IP
```

You should see the marketplace homepage!

---

## Configuration Details

### Generated .env File

After running `./setup.sh`, your `.env` will look like:

```bash
# Database
POSTGRES_PASSWORD=<auto-generated-secure-password>
DATABASE_URL=postgresql://postgres:<password>@db:5432/marketplace

# API Security
SECRET_KEY=<auto-generated-64-char-hex>

# AWS S3
AWS_ACCESS_KEY_ID=AKIAXXXXXXXXXXXXXXXX
AWS_SECRET_ACCESS_KEY=********
S3_BUCKET=my-marketplace-bucket
AWS_REGION=us-east-1

# EC2 Deployment
EC2_PUBLIC_IP=54.123.45.67

# CORS (automatically includes your IP)
CORS_ORIGINS=http://localhost:3000,http://54.123.45.67

# Frontend API URL
NEXT_PUBLIC_API_URL=http://54.123.45.67/api

# Internal API URL (Docker network)
INTERNAL_API_URL=http://api:4000

# Environment
ENVIRONMENT=production
```

### Automatic CORS Configuration

The FastAPI config (`api/app/config.py`) automatically adds your EC2 IP to CORS:

```python
@property
def cors_origins_list(self) -> List[str]:
    origins = [origin.strip() for origin in self.CORS_ORIGINS.split(',')]

    # Auto-add EC2 IP to CORS if configured
    if self.EC2_PUBLIC_IP and self.EC2_PUBLIC_IP != "YOUR_EC2_IP":
        ec2_origin = f"http://{self.EC2_PUBLIC_IP}"
        if ec2_origin not in origins:
            origins.append(ec2_origin)

    return origins
```

This means:
- ✅ No manual CORS configuration needed
- ✅ Works with IP changes (just update .env)
- ✅ Localhost still works for local testing

---

## Testing Your Deployment

### 1. API Health Check
```bash
curl http://YOUR_EC2_IP/api/health
# Expected: {"status":"healthy","environment":"production"}
```

### 2. API Documentation (Development Mode)
```bash
# If ENVIRONMENT=development in .env:
open http://YOUR_EC2_IP/api/docs
```

### 3. Frontend
```bash
curl -I http://YOUR_EC2_IP
# Expected: HTTP/1.1 200 OK

# In browser:
open http://YOUR_EC2_IP
```

### 4. Listings Page (Server-Side Rendering)
```bash
curl -I http://YOUR_EC2_IP/listings
# Expected: HTTP/1.1 200 OK
# Should be server-rendered HTML
```

### 5. S3 Upload Endpoint (Requires Auth)
```bash
curl -X POST http://YOUR_EC2_IP/api/listings/upload-urls?file_count=1
# Expected: 401 Unauthorized (correct - requires login)
```

---

## Common Issues & Solutions

### Issue 1: Cannot Access via IP

**Symptoms**: Browser shows "This site can't be reached"

**Solutions**:
```bash
# Check EC2 security group allows port 80
# Check services are running
docker-compose ps

# Check nginx is accessible
curl localhost
# If this works but IP doesn't, it's a security group issue
```

### Issue 2: CORS Errors in Browser Console

**Symptoms**:
```
Access to XMLHttpRequest at 'http://54.123.45.67/api/...' from origin 'http://54.123.45.67' has been blocked by CORS policy
```

**Solutions**:
```bash
# Verify EC2_PUBLIC_IP in .env
cat .env | grep EC2_PUBLIC_IP
# Should show: EC2_PUBLIC_IP=54.123.45.67

# Verify CORS_ORIGINS includes your IP
cat .env | grep CORS_ORIGINS
# Should include: http://54.123.45.67

# Rebuild API container to pick up changes
docker-compose down
docker-compose up -d --build api

# Check CORS in logs
docker-compose logs api | grep -i cors
```

### Issue 3: 502 Bad Gateway

**Symptoms**: Nginx returns 502 error

**Solutions**:
```bash
# Check API is running
docker-compose ps api

# Check API logs
docker-compose logs api

# Check API health directly
docker-compose exec api curl localhost:4000/health

# Restart services
docker-compose restart api
```

### Issue 4: Out of Memory

**Symptoms**: Services randomly dying, swap usage high

**Solutions**:
```bash
# Check memory usage
free -h
docker stats --no-stream

# Verify swap is active
swapon --show
# Should show 2GB swap file

# Restart services one by one
docker-compose restart db
sleep 10
docker-compose restart api
sleep 5
docker-compose restart web
```

---

## Upgrading to Domain + SSL

When ready for production with a real domain:

### Step 1: Update DNS
```bash
# Point A record to your EC2 IP
yourdomain.com -> 54.123.45.67
```

### Step 2: Update .env
```bash
nano .env

# Change:
EC2_PUBLIC_IP=yourdomain.com
CORS_ORIGINS=http://localhost:3000,https://yourdomain.com
NEXT_PUBLIC_API_URL=https://yourdomain.com/api
```

### Step 3: Install SSL
```bash
sudo certbot --nginx -d yourdomain.com

# Update nginx configuration for HTTPS
# Uncomment HTTPS server block in nginx/nginx.conf

# Restart
docker-compose restart nginx
```

### Step 4: Test HTTPS
```bash
curl https://yourdomain.com/api/health
open https://yourdomain.com
```

---

## Monitoring & Maintenance

### Check Service Status
```bash
docker-compose ps
```

### View Logs
```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f api
docker-compose logs -f web
```

### Monitor Resources
```bash
# System resources
htop
free -h
df -h

# Docker stats
docker stats

# Detailed health check
./health-check.sh
```

### Database Backup
```bash
# Create backup
docker-compose exec db pg_dump -U postgres marketplace > backup.sql

# Restore backup
docker-compose exec -T db psql -U postgres marketplace < backup.sql
```

### Update Application
```bash
git pull origin main
docker-compose down
docker-compose build
docker-compose up -d
```

---

## Cost Estimation

**Monthly Cost** (~$10-15):
- EC2 t3.micro: $7.50
- EBS 20GB: $1.60
- S3 storage (10GB): $0.23
- Data transfer: ~$1.00

**Cost Optimization Tips**:
- Use S3 lifecycle policies for old images
- Enable EBS gp3 (cheaper than gp2)
- Stop instance when not in use (dev/test)
- Use CloudWatch alarms for spend monitoring

---

## Security Notes for IP-Based Deployment

⚠️ **Important**: HTTP (port 80) is not encrypted

**What this means**:
- ✅ Fine for POC and early testing
- ✅ Safe on private networks
- ❌ NOT recommended for production
- ❌ NOT safe for sensitive user data
- ❌ Passwords transmitted in plain text

**Recommendations**:
1. Use HTTPS with Let's Encrypt (free) for production
2. Don't collect sensitive data without SSL
3. Use strong authentication even on HTTP
4. Plan to upgrade to domain + SSL soon

---

## Performance Expectations

On t3.micro with this configuration:

| Metric | Expected Value |
|--------|----------------|
| **Concurrent Users** | 50-100 |
| **API Response Time** | 50-100ms |
| **Page Load Time** | 1-2s (first load) |
| **Memory Usage** | ~900MB / 1GB |
| **Swap Usage** | <500MB normal |

**Load Test**:
```bash
# Install hey
go install github.com/rakyll/hey@latest

# Test API
hey -n 100 -c 10 http://YOUR_EC2_IP/api/listings

# Expected throughput: ~150-250 req/s
```

---

## Support & Troubleshooting

1. **Check logs**: `docker-compose logs`
2. **Run health check**: `./health-check.sh`
3. **Verify .env**: `cat .env | grep -v PASSWORD | grep -v SECRET`
4. **Check memory**: `free -h && docker stats --no-stream`
5. **Review docs**: README.md, IMPROVEMENTS.md

---

## Quick Reference Commands

```bash
# Setup
./setup.sh

# Start
docker-compose up -d

# Stop
docker-compose down

# Restart
docker-compose restart

# Logs
docker-compose logs -f

# Health check
./health-check.sh

# Update
git pull && docker-compose up -d --build

# Backup
docker-compose exec db pg_dump -U postgres marketplace > backup.sql
```

---

**Status**: Production-ready for POC/early-stage deployment
**Version**: 1.1.3 - IP Deployment Support
**Cost**: ~$10-15/month
**Capacity**: 50-100 concurrent users
